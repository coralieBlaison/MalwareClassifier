#action : save the http server use by each pcap in redis (one set per pcap)
# use : pcap$ ls -1 | parallel --gnu " python ../pyshark_filter_http_server_redis.py -f {1}"

import argparse
import sys
import pyshark
import redis

argParser=argparse.ArgumentParser(description='Pcap classifier')
argParser.add_argument('-f',action='append',help='Filename')
args=argParser.parse_args()
r=redis.StrictRedis(host='localhost',port=6379, db=0)

if args.f is not None:
	
	pcap_file_name = args.f[0]
	print('nom : ' + pcap_file_name)

	pcap_file_filtered = pyshark.FileCapture('./'+pcap_file_name, display_filter='http.server')

	for packet in pcap_file_filtered:
		http_server = packet['http'].server
		print(http_server)
		md5 = pcap_file_name.split(".")[0]
		r.sadd(md5,http_server)

else:
	argParser.print_help()
